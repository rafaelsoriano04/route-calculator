<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Rutas - OpenRouteService vs GraphHopper</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            margin: 0; 
            font-family: Arial, sans-serif; 
        }
        header { 
            background: #7a8c5a; 
            color: white; 
            padding: 1rem; 
            text-align: center; 
        }
        .container { 
            display: flex; 
            flex: 1; 
        }
        .sidebar { 
            width: 350px; 
            background: white; 
            padding: 0.75rem; 
            overflow: hidden; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        #map { 
            flex: 1; 
            height: 100%; 
        }
        .sidebar label {
            display: block;
            margin: 0.25rem 0 0.1rem 0;
            font-weight: bold;
            color: #7a8c5a;
            font-size: 13px;
        }
        .sidebar input, 
        .sidebar select { 
            width: 100%; 
            margin: 0 0 0.25rem 0; 
            padding: 0.5rem; 
            border: 2px solid #e0e0e0; 
            border-radius: 6px; 
            font-size: 13px;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }
        .sidebar input:focus, 
        .sidebar select:focus {
            outline: none;
            border-color: #8fa573;
            box-shadow: 0 0 0 3px rgba(143, 165, 115, 0.1);
        }
        .sidebar button { 
            width: 100%; 
            margin: 0.25rem 0; 
            padding: 0.5rem; 
            background: #8fa573; 
            color: white; 
            cursor: pointer; 
            border: none; 
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .sidebar button:hover { 
            background: #7a8c5a; 
        }
        .waypoint-container {
            display: flex;
            gap: 6px;
            margin-bottom: 0.25rem;
        }
        .waypoint-container input {
            flex: 1;
            margin: 0;
        }
        .waypoint-container button {
            width: auto;
            min-width: 40px;
            margin: 0;
            padding: 0.5rem;
        }
        .waypoints-list {
            margin-bottom: 0.5rem;
            max-height: 80px;
            overflow-y: auto;
        }
        .waypoint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.35rem;
            margin: 0.15rem 0;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            font-size: 12px;
        }
        .waypoint-item button {
            width: auto;
            min-width: 25px;
            margin: 0;
            padding: 0.2rem 0.4rem;
            background: #e74c3c;
            font-size: 11px;
        }
        .waypoint-item button:hover {
            background: #c0392b;
        }
        .results { 
            margin-top: 0.5rem; 
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .route-option { 
            padding: 0.6rem; 
            margin-bottom: 0.4rem; 
            border: 2px solid #e0e0e0; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            background: white;
            font-size: 12px;
        }
        .route-option:hover {
            border-color: #8fa573;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .best-route { 
            border: 2px solid #27ae60; 
            background: #eafaf1; 
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.2);
        }
        .vehicle-section,
        .traffic-section {
            margin: 0.5rem 0;
        }
        .calculate-section {
            margin: 0.75rem 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>Comparador de Rutas Óptimas</h1>
        <p>OpenRouteService vs GraphHopper</p>
    </header>

    <div class="container">
        <div class="sidebar">
            <label>Origen:</label>
            <input type="text" id="origin" placeholder="Ej: Parque Montalvo, Ambato">
            
            <label>Destino:</label>
            <input type="text" id="destination" placeholder="Ej: Terminal Terrestre, Ambato">

            <label>Punto intermedio:</label>
            <div class="waypoint-container">
                <input type="text" id="waypoint" placeholder="Ej: Plaza de la Merced, Ambato">
                <button id="add-waypoint">+</button>
            </div>

            <div id="waypoints-container" class="waypoints-list"></div>

            <div class="vehicle-section">
                <label>Tipo de vehículo:</label>
                <select id="vehicle-type">
                    <option value="car">Coche</option>
                    <option value="bike">Bicicleta</option>
                    <option value="foot">A pie</option>
                </select>
            </div>

            <div class="traffic-section">
                <label>Factor de tráfico:</label>
                <select id="traffic-option">
                    <option value="0">Sin tráfico</option>
                    <option value="10">+10%</option>
                    <option value="20">+20%</option>
                    <option value="30">+30%</option>
                </select>
            </div>

            <div class="calculate-section">
                <button id="calculate">Calcular Rutas</button>
            </div>

            <div class="results" id="results"></div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([40.4168, -3.7038], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let waypoints = [];
        let markers = [], polylines = [], routes = [];

        document.getElementById('add-waypoint').addEventListener('click', () => {
            const wp = document.getElementById('waypoint').value.trim();
            if(wp){ waypoints.push(wp); updateWaypoints(); document.getElementById('waypoint').value=''; }
        });

        function updateWaypoints(){
            const container = document.getElementById('waypoints-container');
            container.innerHTML = '';
            waypoints.forEach((wp,i)=>{
                const div = document.createElement('div');
                div.className = 'waypoint-item';
                div.innerHTML = `<span>${wp}</span>`;
                const btn = document.createElement('button');
                btn.textContent='X';
                btn.onclick=()=>{ waypoints.splice(i,1); updateWaypoints(); };
                div.appendChild(btn);
                container.appendChild(div);
            });
        }

        document.getElementById('calculate').addEventListener('click', calculateRoutes);

        async function geocode(address){
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
            const data = await res.json();
            if(!data.length) throw new Error(`No encontrado: ${address}`);
            return {lat:+data[0].lat,lng:+data[0].lon};
        }

        async function calculateRoutes(){
            clearMap();
            const origin = document.getElementById('origin').value;
            const dest = document.getElementById('destination').value;
            const vehicle = document.getElementById('vehicle-type').value;
            const orsKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjIwYTAwZTgzZDBmMjQ5NTk4NjM0OGVhMjU3NDY5Mjg2IiwiaCI6Im11cm11cjY0In0=";
            const ghKey = "a75e2fa4-a114-4d7d-882f-2d761067fb98";

            if(!origin||!dest){ alert('Ingresa origen y destino'); return; }

            const points = [origin, ...waypoints, dest];
            const coords = await Promise.all(points.map(geocode));

            coords.forEach((c,i)=>{ markers.push(L.marker([c.lat,c.lng]).addTo(map).bindPopup(points[i])); });
            map.fitBounds(L.featureGroup(markers).getBounds().pad(0.2));

            const [orsRoute, ghRoute] = await Promise.all([
                routeORS(coords, vehicle, orsKey),
                routeGH(coords, vehicle, ghKey)
            ]);

            routes = [orsRoute, ghRoute];
            displayResults();
        }

        async function routeORS(coords, vehicle, key){
            let profile = vehicle==='bike'? 'cycling-regular': vehicle==='foot'? 'foot-walking':'driving-car';
            const res = await fetch(`https://api.openrouteservice.org/v2/directions/${profile}/geojson`,{
                method:'POST', headers:{'Authorization':key,'Content-Type':'application/json'},
                body:JSON.stringify({coordinates:coords.map(c=>[c.lng,c.lat])})
            });
            const data = await res.json();
            const route = data.features[0];
            const leafletCoords = route.geometry.coordinates.map(c=>[c[1],c[0]]);
            polylines.push(L.polyline(leafletCoords,{color:'green'}).addTo(map)); // color verde
            return {api:'OpenRouteService',distance:(route.properties.summary.distance/1000).toFixed(1),duration:(route.properties.summary.duration/60).toFixed(0)};
        }

        async function routeGH(coords, vehicle, key){
            let profile = vehicle==='bike'? 'bike': vehicle==='foot'? 'foot':'car';
            const points = coords.map(c=>`point=${c.lat},${c.lng}`).join('&');
            const res = await fetch(`https://graphhopper.com/api/1/route?${points}&profile=${profile}&locale=es&key=${key}&instructions=false`);
            const data = await res.json();
            const path = data.paths[0];
            const leafletCoords = decodePolyline(path.points);
            polylines.push(L.polyline(leafletCoords,{color:'blue'}).addTo(map)); // color azul
            return {api:'GraphHopper',distance:(path.distance/1000).toFixed(1),duration:(path.time/60000).toFixed(0)};
        }

        function decodePolyline(encoded){
            let points=[],index=0,lat=0,lng=0;
            while(index<encoded.length){
                let b,shift=0,result=0;
                do{b=encoded.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5;}while(b>=0x20);
                let dlat=((result&1)?~(result>>1):(result>>1));
                lat+=dlat;
                shift=0;result=0;
                do{b=encoded.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5;}while(b>=0x20);
                let dlng=((result&1)?~(result>>1):(result>>1));
                lng+=dlng;
                points.push([lat*1e-5,lng*1e-5]);
            }
            return points;
        }

        function displayResults(){
            const container=document.getElementById('results');
            container.innerHTML='';
            const trafficPercent = parseInt(document.getElementById('traffic-option').value);

            let bestIndex=0; 
            let bestTime=+routes[0].duration;

            const adjustedRoutes = routes.map(r=>{
                let dur = +r.duration;
                if(trafficPercent>0) dur = Math.round(dur * (1 + trafficPercent/100));
                return {...r, duration:dur};
            });

            for(let i=1;i<adjustedRoutes.length;i++){ 
                if(+adjustedRoutes[i].duration<bestTime){
                    bestTime=+adjustedRoutes[i].duration;
                    bestIndex=i;
                } 
            }

            adjustedRoutes.forEach((r,i)=>{
                const div=document.createElement('div');
                div.className='route-option'+(i===bestIndex?' best-route':'');
                div.innerHTML=`<b>${r.api}</b><br>Distancia: ${r.distance} km<br>Duración: ${r.duration} min` + (trafficPercent>0?' (con tráfico)':'');
                container.appendChild(div);
            });
        }

        function clearMap(){ 
            markers.forEach(m=>map.removeLayer(m)); 
            markers=[]; 
            polylines.forEach(p=>map.removeLayer(p)); 
            polylines=[]; 
        }
    </script>
</body>
</html>
